<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="GroceryOrderingApp.Mobile.Views.CartPage"
             Title="Shopping Cart"
             BackgroundColor="{StaticResource BackgroundColor}">
    
    <Grid RowDefinitions="Auto,*,Auto" VerticalOptions="FillAndExpand">
        
        <!-- Header -->
        <StackLayout Grid.Row="0" BackgroundColor="{StaticResource Primary}" Padding="20" Spacing="0">
            <Label Text="ðŸ›’ Your Cart" Style="{StaticResource HeadlineStyle}" 
                   TextColor="White" HorizontalTextAlignment="Center"/>
            <Label Text="{Binding CartItems.Count, StringFormat='Items: {0}'}" 
                   FontSize="12" TextColor="{StaticResource TextSecondary}" 
                   HorizontalTextAlignment="Center" Margin="0,8,0,0"/>
        </StackLayout>
        
        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1" 
                          IsRunning="{Binding IsLoading}" 
                          IsVisible="{Binding IsLoading}"
                          Color="{StaticResource Primary}"
                          Scale="1.8"
                          VerticalOptions="Center"/>
        
        <!-- Cart Items or Empty Message -->
        <ScrollView Grid.Row="1" 
                   IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                   VerticalOptions="FillAndExpand">
            <VerticalStackLayout Padding="12" Spacing="12">
                
                <!-- Empty Cart Message -->
                <StackLayout Padding="20" VerticalOptions="Center" 
                           IsVisible="{Binding CartItems.Count, Converter={StaticResource CountToInvertedBoolConverter}}"
                           Spacing="12">
                    <Label Text="ðŸ›ï¸" FontSize="48" HorizontalTextAlignment="Center"/>
                    <Label Text="Your cart is empty" 
                           Style="{StaticResource SubheadStyle}"
                           HorizontalTextAlignment="Center"
                           TextColor="{StaticResource TextPrimary}"/>
                    <Label Text="Browse categories and add products to get started"
                           FontSize="12"
                           TextColor="{StaticResource TextHint}"
                           HorizontalTextAlignment="Center"
                           LineBreakMode="WordWrap"/>
                </StackLayout>
                
                <!-- Cart Items List -->
                <StackLayout Spacing="12" IsVisible="{Binding CartItems.Count, Converter={StaticResource CountToBool}}">
                    <CollectionView ItemsSource="{Binding CartItems}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Style="{StaticResource CardStyle}" 
                                       HasShadow="True"
                                       BorderColor="{StaticResource Secondary}"
                                       Padding="12">
                                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8" ColumnSpacing="12">
                                        
                                        <!-- Item Details -->
                                        <StackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding ProductName}" 
                                                  Fontsize="14" 
                                                  FontAttributes="Bold"
                                                  TextColor="{StaticResource TextPrimary}"/>
                                            <Label Text="{Binding Price, StringFormat='â‚¹{0:F2} each'}" 
                                                  FontSize="12"
                                                  TextColor="{StaticResource Success}"/>
                                        </StackLayout>
                                        
                                        <!-- Item Total -->
                                        <Label Grid.Row="0" Grid.Column="1"
                                              Text="{Binding TotalPrice, StringFormat='â‚¹{0:F2}'}"
                                              FontSize="14"
                                              FontAttributes="Bold"
                                              TextColor="{StaticResource Primary}"
                                              HorizontalTextAlignment="End"
                                              VerticalTextAlignment="Start"/>
                                        
                                        <!-- Quantity & Actions -->
                                        <Grid Grid.Row="1" Grid.ColumnSpan="2"
                                             ColumnDefinitions="Auto,Auto,Auto,*"
                                             ColumnSpacing="8"
                                             VerticalOptions="Center">
                                            <Label Grid.Column="0" Text="Qty:" FontSize="12" VerticalTextAlignment="Center"/>
                                            <Label Grid.Column="1" Text="{Binding Quantity}" FontSize="13" FontAttributes="Bold"
                                                  VerticalTextAlignment="Center" MinimumWidthRequest="20"/>
                                            
                                            <Button Grid.Column="2"
                                                   Text="âœŽ"
                                                   FontSize="14"
                                                   BackgroundColor="{StaticResource Secondary}"
                                                   TextColor="White"
                                                   Padding="4"
                                                   WidthRequest="36"
                                                   HeightRequest="36"
                                                   CornerRadius="18"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.UpdateQuantityCommand}"
                                                   CommandParameter="{Binding .}"/>
                                            
                                            <Button Grid.Column="3"
                                                   Text="ðŸ—‘ Remove"
                                                   FontSize="11"
                                                   Style="{StaticResource DangerButtonStyle}"
                                                   HorizontalOptions="End"
                                                   Padding="8"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveItemCommand}"
                                                   CommandParameter="{Binding .}"/>
                                        </Grid>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
                
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- Error Message -->
        <Label Grid.Row="1"
               Text="{Binding ErrorMessage}"
               TextColor="{StaticResource Error}"
               FontSize="14"
               LineBreakMode="WordWrap"
               Padding="20"
               HorizontalTextAlignment="Center"
               VerticalOptions="Center"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBool}}"/>
        
        <!-- Checkout Section -->
        <Frame Grid.Row="2"
               BorderColor="{StaticResource PrimaryDark}"
               HasShadow="True"
               Padding="12"
               CornerRadius="12"
               Margin="12,0,12,12"
               IsVisible="{Binding CartItems.Count, Converter={StaticResource CountToBool}}">
            <VerticalStackLayout Spacing="8">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                    <Label Grid.Column="0"
                          Text="Cart Total:"
                          FontSize="14"
                          FontAttributes="Bold"
                          TextColor="{StaticResource TextPrimary}"
                          VerticalOptions="Center"/>
                    <Label Grid.Column="1"
                          Text="{Binding TotalAmount, StringFormat='â‚¹{0:F2}'}"
                          FontSize="16"
                          FontAttributes="Bold"
                          TextColor="{StaticResource Primary}"/>
                </Grid>
                
                <Button Text="ðŸ›’ Place Order"
                       Style="{StaticResource PrimaryButtonStyle}"
                       FontSize="14"
                       Padding="12"
                       Command="{Binding PlaceOrderCommand}"
                       IsEnabled="{Binding CartItems.Count, Converter={StaticResource CountToBool}}"
                       Opacity="{Binding CartItems.Count, Converter={StaticResource CountToBool}, ConverterParameter='1.0|0.5'}"/>
            </VerticalStackLayout>
        </Frame>
        
    </Grid>
    
</ContentPage>
